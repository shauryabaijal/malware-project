#include <cstdio>
#include <filesystem>
#include <iostream>

#include "api_server.h"
#include "ConfigurationManager.h"
#include "ConfigurationTypes.h"
#include "SandboxController.h"
#include "SecureShellManager.h"

#include <libssh/libssh.h>
#include <libssh/callbacks.h>

int main(int argc, char** argv) {

    ssh_threads_set_callbacks(ssh_threads_get_pthread());
    ssh_init();

    //TODO: TEST BEGIN

    /*std::string out, err;

    SecureShellManager ssh("192.168.0.150", 22);
    ssh.connect("tester", "tester");
    InteractiveShell shell = ssh.getInteractiveShell();
    shell.initialize("");

    shell.write_to_channel("sudo docker run -it -v /tmp:/data uptycs_sandbox \n");
    shell.read_from_channel(out, err);
    shell.write_to_channel("ls -lrth /data\n");
    shell.read_from_channel(out, err);
    std::cout << out << std::endl;
    std::cerr << err << std::endl;

    return 0;*/

    //TODO: TEST END

    ConfigurationManager config("config.json");
    VMConfig vm_config;
    SandboxConfig sandbox_config;
    ExecutionConfig exec_config;

    try
    {
        config.load();
        vm_config = config.getVmConfig();
        sandbox_config = config.getSandboxConfig();
        exec_config = config.getExecutionConfig();
    }
    catch (...)
    {
        std::cerr << "Unable to parse configuration file" << std::endl;
        return -1;
    }

    if (argc < 2)
        return -2;

    SandboxController controller(vm_config, sandbox_config, exec_config);
    std::vector<std::filesystem::path> sample_list;
//    std::filesystem::path samples = std::string(argv[1]);
    std::filesystem::path samples = std::string("/home/kni9ht/malware/samples/");

    if (std::filesystem::exists(samples) && std::filesystem::is_directory(samples))
    {
        for (const auto& entry : std::filesystem::directory_iterator(samples))
        {
            if (std::filesystem::is_directory(entry))
                continue;
            //controller.runOneSample(entry);
            sample_list.push_back(entry);
        }
        runServer(vm_config, sandbox_config, exec_config, sample_list);
    }

    ssh_finalize();
    std::cout << "Press any key to exit..." << std::flush;
    getchar();
    return 0;
}
