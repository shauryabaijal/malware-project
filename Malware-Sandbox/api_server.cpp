//
// Created by adhokshajmishra on 30/7/20.
//

#include <filesystem>
#include <mutex>
#include <string>
#include <thread>
#include "api_server.h"
#include "SandboxController.h"

std::mutex sandbox_mutex;
bool isRunning;

void runSandbox(SandboxController controller, std::filesystem::path sample)
{
    {
        std::lock_guard<std::mutex> lock(sandbox_mutex);
        isRunning = true;
    }
    controller.runOneSample(sample, true, false);
    {
        std::lock_guard<std::mutex> lock(sandbox_mutex);
        isRunning = false;
    }
}

void runServer(VMConfig vm_config, SandboxConfig sandbox_config, ExecutionConfig exec_config,
               std::vector<std::filesystem::path> samples)
{
    httplib::Server server;
    SandboxController controller(vm_config, sandbox_config, exec_config);

    unsigned int start = 0, stop = samples.size();
    bool isFirstRun = true;

    server.Get("/vmcontrol", [&](const httplib::Request& req, httplib::Response& res) {

        if (isFirstRun)
        {
            isFirstRun = false;
            res.set_content("restart", "text/plain");
        }
        else
        {
            std::lock_guard<std::mutex> lock(sandbox_mutex);
            if (isRunning)
                res.set_content("hold", "text/plain");
            else
                res.set_content("restart", "text/plain");
        }
    });

    server.Get("/run", [&](const httplib::Request& req, httplib::Response& res) {
        bool status;
        {
            std::lock_guard<std::mutex> lock(sandbox_mutex);
            status = isRunning;
        }
        if (status)
        {
            res.set_content("already running", "text/plain");
            return;
        }

        if (start < stop)
        {
            std::thread t(runSandbox, controller, samples[start]);
            ++start;
            t.detach();
            res.set_content("success", "text/plain");
        }
        else
        {
            res.set_content("nothing to do", "text/plain");
        }
    });

    server.listen("0.0.0.0", 8000);
}