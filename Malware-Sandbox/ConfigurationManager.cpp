//
// Created by adhokshajmishra on 28/7/20.
//

#include <fstream>
#include <streambuf>
#include "ConfigurationManager.h"

ConfigurationManager::ConfigurationManager(std::string path) {
    this->config_path = path;
}

ConfigurationManager::~ConfigurationManager() {
}

void ConfigurationManager::load() {
    std::ifstream file(config_path);
    std::string data = "";
    data.assign(std::istreambuf_iterator<char>(file), std::istreambuf_iterator<char>());

    config = nlohmann::json::parse(data);
}

VMConfig ConfigurationManager::getVmConfig() {
    VMConfig vmconfig;

    if (config.contains("vm_configuration"))
    {
        auto _vm = config["vm_configuration"];
        if (_vm.contains("vm_name"))
            vmconfig.vm_name = _vm["vm_name"];
        if (_vm.contains("snapshot_name"))
            vmconfig.snapshot_name = _vm["snapshot_name"];
        if (_vm.contains("ip_address"))
            vmconfig.ip_address = _vm["ip_address"];
        if (_vm.contains("port"))
            vmconfig.port = _vm["port"];
        if (_vm.contains("username"))
            vmconfig.username = _vm["username"];
        if (_vm.contains("password"))
            vmconfig.password = _vm["password"];
        if (_vm.contains("is_sudo"))
            vmconfig.is_sudo = _vm["is_sudo"];
        if (_vm.contains("is_sudo_password"))
            vmconfig.is_sudo_password = _vm["is_sudo_password"];
        if (_vm.contains("sudo_password"))
            vmconfig.sudo_password = _vm["sudo_password"];
        if (_vm.contains("upload_path"))
            vmconfig.upload_path = _vm["upload_path"];
    }

    return vmconfig;
}

SandboxConfig ConfigurationManager::getSandboxConfig() {
    SandboxConfig sandbox_config;
    sandbox_config.pre_exec.clear();
    sandbox_config.post_exec.clear();

    if (config.contains("sandbox_configuration"))
    {
        auto _sandbox = config["sandbox_configuration"];

        if (_sandbox.contains("pre_exec"))
        {
            auto _exec = _sandbox["pre_exec"];

            for (auto& entry : _exec)
            {
                sandbox_command cmd;
                if (entry.contains("command"))
                    cmd.command = entry["command"];
                if (entry.contains("use_sudo"))
                    cmd.isSudo = entry["use_sudo"];

                sandbox_config.pre_exec.push_back(cmd);
            }
        }

        if (_sandbox.contains("post_exec"))
        {
            auto _exec = _sandbox["post_exec"];

            for (auto& entry : _exec)
            {
                sandbox_command cmd;
                if (entry.contains("command"))
                    cmd.command = entry["command"];
                if (entry.contains("use_sudo"))
                    cmd.isSudo = entry["use_sudo"];

                sandbox_config.post_exec.push_back(cmd);
            }
        }

        if (_sandbox.contains("interim_exec"))
        {
            auto _exec = _sandbox["interim_exec"];
            if (_exec.contains("command"))
                sandbox_config.interim_exec.command = _exec["command"];
            if (_exec.contains("use_sudo"))
                sandbox_config.interim_exec.isSudo = _exec["use_sudo"];
            if (_exec.contains("interval"))
                sandbox_config.interim_exec.interval = _exec["interval"];
            if (_exec.contains("output_file"))
                sandbox_config.interim_output = _exec["output_file"];
        }

        if (_sandbox.contains("execution_output"))
        {
            sandbox_config.execution_ouput = _sandbox["execution_output"];
        }
    }

    return sandbox_config;
}

ExecutionConfig ConfigurationManager::getExecutionConfig() {
    ExecutionConfig exec_config;
    return exec_config;
}